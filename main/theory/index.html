<!DOCTYPE html>

<html class="writer-html5" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="../img/favicon.ico" rel="shortcut icon"/>
<title>Theory of Operation - SDS-Framework</title>
<link href="../css/theme.css" rel="stylesheet"/>
<link href="../css/theme_extra.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" rel="stylesheet"/>
<link href="../css/extra.css" rel="stylesheet"/>
<script>
        // Current page data
        var mkdocs_page_name = "Theory of Operation";
        var mkdocs_page_input_path = "theory.md";
        var mkdocs_page_url = null;
      </script>
<!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
<script>hljs.highlightAll();</script>
</head>
<body class="wy-body-for-nav" role="document">
<div class="wy-grid-for-nav">
<nav class="wy-nav-side stickynav" data-toggle="wy-nav-shift">
<div class="wy-side-scroll">
<div class="wy-side-nav-search">
<a class="icon icon-home" href=".."> SDS-Framework
        </a><div role="search">
<form action="../search.html" class="wy-form" id="rtd-search-form" method="get">
<input aria-label="Search docs" name="q" placeholder="Search docs" title="Type search term here" type="text"/>
</form>
</div>
</div>
<div aria-label="Navigation menu" class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation">
<ul>
<li class="toctree-l1"><a class="reference internal" href="..">Home</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../overview/">Overview</a>
</li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal current" href="#">Theory of Operation</a>
<ul class="current">
<li class="toctree-l2"><a class="reference internal" href="#usage">Usage</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="#buffer-size">Buffer Size</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="#timestamp">Timestamp</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="#sds-file-format">SDS File Format</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="#sdsio-server-protocol">SDSIO Server Protocol</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="#sdsio-message-sequence">SDSIO Message Sequence</a>
</li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../sds_interface/">SDS Interface</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../examples/">Examples</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../utilities/">Utilities</a>
</li>
</ul>
</div>
</div>
</nav>
<section class="wy-nav-content-wrap" data-toggle="wy-nav-shift">
<nav aria-label="Mobile navigation menu" class="wy-nav-top" role="navigation">
<i class="fa fa-bars" data-toggle="wy-nav-top"></i>
<a href="..">SDS-Framework</a>
</nav>
<div class="wy-nav-content">
<div class="rst-content"><div aria-label="breadcrumbs navigation" role="navigation">
<ul class="wy-breadcrumbs">
<li><a aria-label="Docs" class="icon icon-home" href=".."></a></li>
<li class="breadcrumb-item active">Theory of Operation</li>
<li class="wy-breadcrumbs-aside">
<a class="icon icon-github" href="https://github.com/ARM-software/SDS-Framework/edit/main/documentation/theory.md"> Edit on GitHub</a>
</li>
</ul>
<hr/>
</div>
<div class="document" itemscope="itemscope" itemtype="http://schema.org/Article" role="main">
<div class="section" itemprop="articleBody">
<h1 id="theory-of-operation">Theory of Operation</h1>
<!-- markdownlint-disable MD013 -->
<!-- markdownlint-disable MD036 -->
<p>The SDS Framework enables to record and playback one or more data streams to an application that is under development as shown in the diagram below. With the SDSIO Interface the data streams are connected to SDS data files. The file storage can be either embedded within the system and access by a file system or external on a host computer and accessed by a communication interface such as Ethernet or USB.</p>
<p>The DSP or ML algorithms that are tested operate on blocks and are executed periodically. This documentation uses these terms:</p>
<ul>
<li><strong>Block size</strong>: is the number of bytes processed by a DSP or ML compute node.</li>
<li><strong>Interval</strong>: is the periodic time interval that the compute node executes.</li>
</ul>
<p><img alt="SDSIO Interface for Player and Recorder" src="../images/SDS-InOut.png"/></p>
<p>The core of the SDS-Framework is a circular buffer handling (<code>sds.c/h</code>) that is controlled by the Recorder/Player interface functions (<code>sdsRec.c/h</code>/<code>sdsPlay.c/h</code>). This circular buffer is the queue for the file I/O communication (<code>sdsio.c/h</code>). Using the Recorder/Player functions, the data stream under development may read and write data streams as shown in the diagram above.</p>
<p><img alt="Implementation Files of SDS" src="../images/Theory_of_Operation.png"/></p>
<h2 id="usage">Usage</h2>
<p>The following diagram shows the usage of the SDS Recorder and Player functions.  Management is a separate thread that controls the overall execution. Algorithm is a thread that executes Signal Conditioning (SC) and ML Model.</p>
<div class="mermaid">sequenceDiagram
    participant Management
    participant SDS Player
    participant SDS Recorder
    participant Algorithm
    Management-&gt;&gt;SDS Player: sdsPlayOpen `SCinput`
    Management-&gt;&gt;SDS Recorder: sdsRecOpen `SCoutput`
    Management-&gt;&gt;SDS Recorder: sdsRecOpen `MLoutput`
    Management-&gt;&gt;Algorithm: Activate Algorithm
    Activate Algorithm
    loop periodic
        SDS Player-&gt;&gt;Algorithm: sdsPlayReads `SCinput` (with timestamp)
        Note over Algorithm: Execute Signal Conditioning
        Algorithm-&gt;&gt;SDS Recorder: sdsRecWrite `SCoutput`
        Note over Algorithm: Execute ML Model
        Algorithm-&gt;&gt;SDS Recorder: sdsRecWrite `MLoutput`
    end
    Management-&gt;&gt;Algorithm: Deactivate Algorithm
    Deactivate Algorithm
    Management-&gt;&gt;SDS Player: sdsPlayClose `SCinput`
    Management-&gt;&gt;SDS Recorder: sdsRecClose `SCoutput`
    Management-&gt;&gt;SDS Recorder: sdsRecClose `MCoutput`
</div>
<p>Each data stream is stored in a separate SDS data file. In the diagram below <code>SCinput.0.sds</code> is the input to Signal Conditioning, <code>SCoutput.0.sds</code> is the output of Signal Conditioning, and <code>MLoutput.0.sds</code> is the output of the ML Model. Each execution of the algorithm is represented in a data block with a <code>timestamp</code>. The <code>timestamp</code> allows to correlate the blocks of different streams. In the above example, all blocks of one algorithm execution have the same timestamp value.</p>
<p><img alt="SDS Files" src="../images/SDS-Files.png"/></p>
<p>ToDo When does sdsRecInit require an event handler?</p>
<p><strong>Example:</strong> Recording of an accelerometer data stream</p>
<p>The following code snippets show the usage of the <strong>Recorder Interface</strong>.</p>
<pre><code class="language-c">// *** variable definitions ***
struct {                          // sensor data stream format
  uint16_t x;
  uint16_t y;
  uint16_t z;
} accelerometer [30];             // number of samples in one data stream record

sdsRecId_t *accel_id,             // data stream id
uint8_t accel_buf[1000];          // data stream buffer for circular buffer handling
     :
// *** function calls ***
   sdsRecInit(NULL);              // init SDS Recorder  
     :
   // open data stream for recording
   accel_id = sdsRecOpen("Accel", accel_buf, sizeof(accel_buf), 2*(sizeof(accelerometer));
     :
   // write data in accelerometer buffer with timestamp from RTOS kernel.
   timestamp = osKernelGetTickCount();
   n = sdsRecWrite(accel_id, timestamp, accelerometer, sizeof(accelerometer));
   if (n != sizeof(accelerometer)) {
     ... // unexpected size returned, error handling
   }
     :
  sdsRecClose (accel_id);         // close data stream 
</code></pre>
<h2 id="buffer-size">Buffer Size</h2>
<p>The size of the data stream buffer depends on several factors such as:</p>
<ul>
<li>the communication interface used as the technology may impose certain buffer sizes to maximize the transfer rate.</li>
<li>the size of the data stream as it is recommended that the buffer is at least three the size of a single data stream.</li>
<li>the frequency of the algorithm execution. Fast execution speeds may require a larger buffer.</li>
</ul>
<p>A a guideline, the buffer size should be 3 times the <strong>block size</strong>. As a minimum 0x1000 (4 KB) is recommended.</p>
<p>ToDo: Threshold should be optional</p>
<p><strong>Recommended Buffer Size:</strong></p>
<p>The table below contains recommended buffer sizes depending on the communication technology used:</p>
<p>ToDo</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Communication</th>
<th style="text-align: left;">Buffer Size</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">Network</td>
<td style="text-align: left;">4096</td>
<td style="text-align: left;">Default size of Ethernet record is xxxx bytes</td>
</tr>
<tr>
<td style="text-align: left;">USB Device</td>
<td style="text-align: left;">xxx</td>
<td style="text-align: left;">.</td>
</tr>
<tr>
<td style="text-align: left;">FileSystem</td>
<td style="text-align: left;">xxx</td>
<td style="text-align: left;">.</td>
</tr>
</tbody>
</table>
<h2 id="timestamp">Timestamp</h2>
<p>The timestamp is a 32-bit unsigned value and is used for:</p>
<ul>
<li>Alignment of different data streams that have the same timestamp value.</li>
<li>Order of the SDS data files captured during execution.</li>
<li>Combining multiple SDS file records with the same timestamp value.</li>
</ul>
<p>The same timestamp connects different SDS file records. It is therefore useful to
use the same timestamp for the recording of one iteration of a DSP or ML algorithm.
In most cases the granularity of an RTOS tick (typically 1ms) is a good choice for a timestamp value.</p>
<h2 id="sds-file-format">SDS File Format</h2>
<p>The SDS file format is described <a href="https://github.com/ARM-software/SDS-Framework/tree/main/schema">here</a>.  Each call to 
<code>sdsRecWrite</code> creates one record.</p>
<h2 id="sdsio-server-protocol">SDSIO Server Protocol</h2>
<p>The SDSIO Server uses a simple protocol for data exchange between a Host computer and the embedded target that integrates an <a href="../sds_interface/">SDSIO Interface</a>.  The protocol assumes that the correct communication to the server is already ensured by the underlying technology (TCP/IP or USB) and therefore no extra check is implemented.</p>
<p>The following conventions describe the command semantic used in the following documentation"</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Symbol</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">&gt;</td>
<td style="text-align: left;">Prefix indicating the direction: Command from target to Host.</td>
</tr>
<tr>
<td style="text-align: left;">&lt;</td>
<td style="text-align: left;">Prefix indicating the direction: Response from Host to target.</td>
</tr>
<tr>
<td style="text-align: left;">WORD</td>
<td style="text-align: left;">32-bit value (low byte first).</td>
</tr>
<tr>
<td style="text-align: left;">****</td>
<td style="text-align: left;">The field above has exactly one occurrence.</td>
</tr>
<tr>
<td style="text-align: left;">++++</td>
<td style="text-align: left;">The field above has a variable length.</td>
</tr>
</tbody>
</table>
<p><strong>Commands:</strong></p>
<p>Commands are send from the embedded target to the Host computer that is running the SDSIO Server.</p>
<table>
<thead>
<tr>
<th style="text-align: center;">ID</th>
<th style="text-align: left;">Name</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">1</td>
<td style="text-align: left;">SDSIO_CMD_OPEN</td>
<td style="text-align: left;">Open a SDS data file</td>
</tr>
<tr>
<td style="text-align: center;">2</td>
<td style="text-align: left;">SDSIO_CMD_CLOSE</td>
<td style="text-align: left;">Close a SDS data file</td>
</tr>
<tr>
<td style="text-align: center;">3</td>
<td style="text-align: left;">SDSIO_CMD_WRITE</td>
<td style="text-align: left;">Write to SDS data file</td>
</tr>
<tr>
<td style="text-align: center;">4</td>
<td style="text-align: left;">SDSIO_CMD_READ</td>
<td style="text-align: left;">Read from SDS data file</td>
</tr>
<tr>
<td style="text-align: center;">5</td>
<td style="text-align: left;">SDSIO_CMD_EOS</td>
<td style="text-align: left;">End of Stream</td>
</tr>
</tbody>
</table>
<p>Each Command starts with a Header (4 Words) and optional data with variable length. Depending on the Command, the SDSIO Server replies with a Response that repeats the Header and delivers additional data.</p>
<p><strong>SDSIO_CMD_OPEN</strong></p>
<p>The Command ID=1 <strong>SDSIO_CMD_OPEN</strong> opens an SDS data file on the Host computer.</p>
<p>SDS data filenames use the following file format: <code>&lt;name&gt;.&lt;file-index&gt;.sds</code>. <code>Name</code> is the base file name of the SDS data file. <code>Len of Name</code> is the size of the string in bytes. <code>&lt;file-index&gt;</code> is a sequential number starting from <code>0</code>.</p>
<p><code>Mode</code> defines <code>read</code> (value=0) or <code>write</code> (value=1) operation. For <code>write</code>, the server inserts the next available <code>&lt;file-index&gt;</code> number that does not exist yet (if <code>Name.3.sds</code> exists, the server creates <code>Name.4.sds</code>). For <code>read</code> the server maintains a list of <code>Names</code> that where previously used. When a Name was not used before it opens <code>&lt;file-index&gt;=0</code>, i.e. <code>Name.0.sds</code>.</p>
<pre><code class="language-txt">| WORD | WORD **| WORD | WORD *******|++++++|
&gt;  1   |   0    | Mode | Len of Name | Name |
|******|********|******|*************|++++++|
</code></pre>
<p>The Response ID=1 <strong>SDSIO_CMD_OPEN</strong> provides a <code>Handle</code> that is used to identify the file in subsequent commands.</p>
<pre><code class="language-txt">| WORD | WORD **| WORD | WORD *******|
&lt;  1   | Handle | Mode | 0           |
|******|********|******|*************|
</code></pre>
<p><strong>SDSIO_CMD_CLOSE</strong></p>
<p>The Command ID=2 <strong>SDSIO_CMD_CLOSE</strong> closes an SDS data file on the Host computer. The <code>Handle</code> is the identifier obtained with <strong>SDSIO_CMD_OPEN</strong>. There is no Response from the SDSIO Server on this command.</p>
<pre><code class="language-txt">| WORD |  WORD  | WORD | WORD |
&gt;  2   | Handle |  0   |  0   |
|******|********|******|******|
</code></pre>
<p><strong>SDSIO_CMD_WRITE</strong></p>
<p>The Command ID=3 <strong>SDSIO_CMD_WRITE</strong> writes data to an SDS data file on the Host computer. The <code>Handle</code> is the identifier obtained with <strong>SDSIO_CMD_OPEN</strong>. <code>Size</code> is the <code>Data</code> size in bytes.  There is no Response from the SDSIO Server on this command.</p>
<pre><code class="language-txt">| WORD |  WORD  | WORD | WORD |++++++|
&gt;  3   | Handle |  0   | Size | Data |
|******|********|******|******|++++++|
</code></pre>
<p><strong>SDSIO_CMD_READ</strong></p>
<p>The Command ID=4 <strong>SDSIO_CMD_READ</strong> reads data from an SDS data file on the Host computer. The <code>Handle</code> is the identifier obtained with <strong>SDSIO_CMD_OPEN</strong>. <code>Size</code> are the number of bytes that should be read.</p>
<pre><code class="language-txt">| WORD |  WORD  | WORD | WORD |
&gt;  4   | Handle | Size |   0  |
|******|********|******|******|
</code></pre>
<p>The Response ID=4 <strong>SDSIO_CMD_READ</strong> provides the data read from an SDS data file on the HOST computer.
<code>Size</code> is the <code>Data</code> size in bytes that is read.</p>
<pre><code class="language-txt">| WORD |  WORD  | WORD | WORD |++++++|
&lt;  4   | Handle |  0   | Size | Data |
|******|********|******|******|++++++|
</code></pre>
<p><strong>SDSIO_CMD_EOS</strong></p>
<p>The Command ID=5 <strong>SDSIO_CMD_EOS</strong> checks if the end of file is reached. The <code>Handle</code> is the identifier obtained with <strong>SDSIO_CMD_OPEN</strong>.</p>
<pre><code class="language-txt">| WORD |  WORD  | WORD | WORD |
&gt;  5   | Handle |  0   |   0  |
|******|********|******|******|
</code></pre>
<p>The Response ID=5 <strong>SDSIO_CMD_EOS</strong> returs the <code>Status</code> with nonzero = end of stream, else 0</p>
<pre><code class="language-txt">| WORD |  WORD  | WORD   | WORD |
&lt;  5   | Handle | Status |   0  |
|******|********|********|******|
</code></pre>
<p>ToDo: I don't understand why this command is needed as <strong>SDSIO_CMD_READ</strong> returns indirectly this status already.  Also the <code>nonzero</code> above needs work.</p>
<h2 id="sdsio-message-sequence">SDSIO Message Sequence</h2>
<p>This is the message sequence of the SDS DataTest example when connected to MDK-Middleware Ethernet.
It contains the following threads that executes on the target.</p>
<ul>
<li>Management: Overall execution management</li>
<li>Algorithm: Algorithm under test</li>
<li>Recorder: SDS Recorder thread (sdsRecThread)</li>
<li>Playback: SDS Playback thread (sdsPlayThread)</li>
</ul>
<p>The Server is the SDSIO Server executing on the target system.</p>
<div class="mermaid">sequenceDiagram
    participant Management
    participant Algorithm
    create participant Recorder as SDS Recorder
    participant Server as SDSIO Server
    Management-&gt;&gt;Recorder: sdsRecInit
    Note over Management: sdsRecOpen
    Management-&gt;&gt;Server: SDSIO_CMD_OPEN
    activate Server
    Server--&gt;&gt;Management: Response
    activate Algorithm
    loop periodic
        Note over Algorithm: sdsRecWrite
        Algorithm-&gt;&gt;Recorder: Threshold Trigger
        loop send all data
            Recorder-&gt;&gt;Server: SDSIO_CMD_WRITE
        end
    end
    deactivate Algorithm
    Note over Management: sdsRecClose
    Management-&gt;&gt;Recorder: Close Trigger
    loop send all data
        Recorder-&gt;&gt;Server: SDSIO_CMD_WRITE
    end
    Recorder-&gt;&gt;Management: Close Confirm
    Management-&gt;&gt;Server: SDSIO_CMD_CLOSE
    deactivate Server
</div>
<p>ToDo:</p>
<ul>
<li>create similar diagram for Playback</li>
<li>should Playback and Record use the same Thread?</li>
<li>How is the buffer filled on PlayOpen?</li>
<li>document control blocks in sds.c, sds_rec.c, and sds_play.c (comments might be sufficient)</li>
</ul>
<p>How does Threshold work?</p>
<ul>
<li>when Threshold is reach, the write operation writes the whole buffer.  The transport layer (TCP/IP) may need to split this into multiple packs. Should size be optimized for transport layer?</li>
<li>This writes all buffers https://github.com/ARM-software/SDS-Framework/blob/main/sds/source/sds_rec.c#L157 until empty. When Recorder is same priority as Algorithm, Algorithm might not be executed for quite a while.</li>
</ul>
<p>sds.c generates detailed events (are they documented?)
but sds_rec.c does not really use this information</p>
<ul>
<li>Threshold event is only set when complete write was possible, is this correct? https://github.com/ARM-software/SDS-Framework/blob/main/sds/source/sds_rec.c#L298 </li>
</ul>
<p>https://github.com/Arm-Examples/SDS-Examples/blob/main/Hardware/DataTest/rec_management.c
- do we really need <code>recdone</code>?</p>
</div>
</div><footer>
<div aria-label="Footer Navigation" class="rst-footer-buttons" role="navigation">
<a class="btn btn-neutral float-left" href="../overview/" title="Overview"><span class="icon icon-circle-arrow-left"></span> Previous</a>
<a class="btn btn-neutral float-right" href="../sds_interface/" title="SDS Interface">Next <span class="icon icon-circle-arrow-right"></span></a>
</div>
<hr/>
<div role="contentinfo">
<!-- Copyright etc -->
</div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
</div>
</div>
</section>
</div>
<div aria-label="Versions" class="rst-versions" role="note">
<span class="rst-current-version" data-toggle="rst-current-version">
<span>
<a class="fa fa-github" href="https://github.com/ARM-software/SDS-Framework" style="color: #fcfcfc"> GitHub</a>
</span>
<span><a href="../overview/" style="color: #fcfcfc">« Previous</a></span>
<span><a href="../sds_interface/" style="color: #fcfcfc">Next »</a></span>
</span>
</div>
<script src="../js/jquery-3.6.0.min.js"></script>
<script>var base_url = "..";</script>
<script src="../js/theme_extra.js"></script>
<script src="../js/theme.js"></script>
<script src="../search/main.js"></script>
<script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>
<script type="module">import mermaid from "https://unpkg.com/mermaid@10.4.0/dist/mermaid.esm.min.mjs";
mermaid.initialize({});</script></body>
</html>
